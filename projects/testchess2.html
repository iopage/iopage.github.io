<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multiplayer Chess</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .board { width: 400px; max-width: 90vw; margin: 0 auto; }
        .dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 6px; }
    </style>
</head>
<body class="bg-slate-900 text-slate-100 min-h-screen flex flex-col items-center p-4">

    <h1 class="text-3xl font-bold my-6 text-indigo-400">GitHub Chess</h1>

    <div class="bg-slate-800 p-6 rounded-xl shadow-2xl border border-slate-700 w-full max-w-md mb-6">
        <div class="mb-4 text-center text-xs font-bold uppercase tracking-widest flex items-center justify-center">
            <span id="status-dot" class="dot bg-red-500"></span>
            <span id="status-text">Disconnected</span>
        </div>
        
        <div class="space-y-4">
            <input id="room-id" placeholder="Enter Room Name (e.g. secret-match)" class="bg-slate-900 border border-slate-600 rounded p-2 text-sm w-full outline-none focus:border-indigo-500">
            <button id="join-btn" disabled class="w-full bg-indigo-600 hover:bg-indigo-500 py-2 rounded font-bold transition disabled:opacity-30">JOIN GAME</button>
        </div>
    </div>

    <div id="board" class="board shadow-2xl rounded overflow-hidden"></div>
    <p id="turn-display" class="mt-6 text-xl font-semibold text-slate-400">Waiting for room...</p>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { Chessboard, COLOR, INPUT_EVENT_TYPE } from "https://cdn.jsdelivr.net/npm/cm-chessboard@8/src/cm-chessboard/Chessboard.js";
        import { Chess } from "https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.13.4/chess.js";

        // Your actual Firebase keys provided:
        const firebaseConfig = {
            apiKey: "AIzaSyCViFJzs4K3-8sY7KiFuvnonYVjhPD81OY",
            authDomain: "mygithubchess.firebaseapp.com",
            projectId: "mygithubchess",
            storageBucket: "mygithubchess.firebasestorage.app",
            messagingSenderId: "122840137866",
            appId: "1:122840137866:web:7247bf33f067959516ad73"
        };

        // Initialize
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let game = new Chess();
        let board, user, myColor, roomRef, unsubscribe;

        // Login
        signInAnonymously(auth).catch(err => console.error("Auth Error", err));
        onAuthStateChanged(auth, (u) => {
            if (u) {
                user = u;
                document.getElementById("status-dot").className = "dot bg-green-500";
                document.getElementById("status-text").innerText = "Online";
                document.getElementById("join-btn").disabled = false;
            }
        });

        document.getElementById("join-btn").onclick = async () => {
            const roomName = document.getElementById("room-id").value.trim();
            if (!roomName) return;
            
            roomRef = doc(db, "rooms", roomName);
            const snap = await getDoc(roomRef);

            if (!snap.exists()) {
                myColor = 'w';
                await setDoc(roomRef, { fen: game.fen(), white: user.uid, turn: 'w' });
            } else {
                const data = snap.data();
                myColor = (data.white === user.uid) ? 'w' : 'b';
                if (myColor === 'b') await updateDoc(roomRef, { black: user.uid });
            }
            
            startChess();
            if (unsubscribe) unsubscribe();
            unsubscribe = onSnapshot(roomRef, (doc) => {
                const data = doc.data();
                if (data && data.fen !== game.fen()) {
                    game.load(data.fen);
                    board.setPosition(data.fen, true);
                }
                updateUI();
            });
        };

        function startChess() {
            board = new Chessboard(document.getElementById("board"), {
                position: game.fen(),
                orientation: myColor === 'b' ? COLOR.black : COLOR.white,
                assetsUrl: "https://cdn.jsdelivr.net/npm/cm-chessboard@8/assets/",
                style: { pieces: { type: "standard" } }
            });

            board.enableMoveInput(async (event) => {
                if (game.turn() !== myColor) return false;
                if (event.type === INPUT_EVENT_TYPE.validateMoveInput) {
                    const move = game.move({ from: event.squareFrom, to: event.squareTo, promotion: 'q' });
                    if (move) {
                        await updateDoc(roomRef, { fen: game.fen(), turn: game.turn() });
                        return true;
                    }
                }
                return true;
            }, myColor === 'w' ? COLOR.white : COLOR.black);
            updateUI();
        }

        function updateUI() {
            const turn = game.turn() === 'w' ? "White" : "Black";
            const isMe = game.turn() === myColor;
            document.getElementById("turn-display").innerText = isMe ? "Your Turn!" : `${turn}'s Turn...`;
            document.getElementById("turn-display").className = isMe ? "mt-6 text-xl font-bold text-green-400" : "mt-6 text-xl font-semibold text-slate-400";
        }
    </script>
</body>
</html>